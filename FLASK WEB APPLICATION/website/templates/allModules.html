{% extends "base.html" %}
{% block content%}


<style>
  .timeplan {
    background-color: rgba(0, 0, 0, 0.7);
    position: fixed;
    display: none;
    width: 100vw;
    height: 100vh;
    z-index: 2;
    justify-items: center;
    align-items: center;
    justify-content: center;
    font-size: 6vw;
  }

  .timewindow {
    background-color: white;
    width: 90%;
    height: 90%;
  }

  .tableFrame {
    max-height: 75%;
    width: 100%;
    overflow-y: scroll;
  }

  table {
    width: 100%;
  }

  table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
  }

  .titleBar {
    display: flex;
    justify-content: space-between;
  }

  .tableButton {
    width: 100%;
    font-size: 6vw;
  }

  .lastColumn {
    width: 6vw;
  }

  .deleteButton, .acceptButton {
    width: 100%;
    height: 10vw;
    background-color: red;
    color: white;
  }

  .acceptButton {
    background-color: green;
  }

  .timeChooseButton {
    height: 10vw;
    width: 10vw;
    font-size: 6vw;
  }

  .newTimeCont {
    display: flex;
    justify-content: space-between;
  }

  .timeCont {
    width: 15vw;
  }
</style>


<div class="timeplan" id="timeplan">
  <div class="timewindow">
    <div class="titleBar">
      <div>Zeitplan</div>
      <button onclick="closePlan()" style="font-size:6vw;">X</button>
    </div>
    <div id="tableFrame" class="tableFrame">
      <table id="timeTable">
        <tr>
          <th>Uhrzeit</th>
          <th>Aktion</th>
          <th class="lastColumn">Entf</th>
        </tr>
      </table>
    </div>
    
    <button onclick="addAction(0)" id="addButton" class="tableButton">
      Neu
    </button>
  </div>
</div>


<div class="bigButtonContainer">
  <div class="headerSpace"></div>

  {% if modules['lights'][1] %}

  <div id="blindControl">
    <div class="configContainer">
        <div class="flex">

            <div class="controlLeft">
                <div class="lightBulb" id="all"></div>
                <button onclick="lightOn(-1)" class="controlButton">
                    <div class="buttonFont">ON</div>
                </button>
            </div>

            <div class="controlRight">

                <div class="controlHeader">
                    <div>&nbsp;Alle Lichter</div>
                    <div>aus&nbsp;</div>
                </div>

                <div class="configButtons">
                    <button id="automaticAll" onclick="automatic(-2, ), switchButtonClass(id)" class="automaticButton{{room.autoLights}}">AUTOMATIK</button>
                    <button class="automaticButtonFalse">Schwellwert</button>
                </div>

            </div>
        </div>
    </div>
</div>

  {% endif %}

  {% if modules['blinds'][1] %}

  {% include 'allBlinds.html' %}

  {% endif %}

  {% include 'listLights.html' %}

  {% include 'listBlinds.html' %}

</div>



<script>






  let blind_id;
  let plan = document.getElementById("timeplan");
  let tableRows = document.getElementById("timeTable");
  let tableFrame = document.getElementById("tableFrame");
  let addButton = document.getElementById("addButton");
  let modulesActions = [];

  let newTime = "06:00";
  let newAction = "0";

  function saveBlind_id(id) {
    blind_id = id;
  }

  function redrawTimeplan(id) {
    saveBlind_id(id);
    resetAddButton();
    rebuildTableHeader(tableRows);
    getTimeEntries(id)
      .then(displayEntries)
      .catch(error => {
        console.log(error);
      });
  }


  function driveButton(id) {
    let portActionSplit = id.split("/");
    let port = portButtonSplit[1];
    let action = portButtonSplit[0];
    saveDriveButtonStates(port, action);
  }

  function saveDriveButtonStates(port, state) {
    $.ajax({
      url: "/updateButtonStates/" + port,
      type: 'POST',
      data: {'state': state},
      success: function (response) {
        console.log(response);
      },
      error: function (error) {
        console.log(error);
      }
    });
  }

  function redrawDriveButtons() {
    console.log("Redrawing drive buttons now.")
  }

  function switchButtonClass(id) {
    button = document.getElementById(id);
    if (button.classList.contains("automaticButtonTrue")) {
      button.classList.remove("automaticButtonTrue");
      button.classList.add("automaticButtonFalse");
    } else {
      button.classList.remove("automaticButtonFalse");
      button.classList.add("automaticButtonTrue");
    }
  }

  function lightOn(id) {
    let lightBulb = document.getElementById(id);
    lightBulb.classList.add("lightBulbOn");
  }

  function longPress(button) {
    let opposite = getOpposite(button);
    button.classList.remove("buttonLocked");
    console.log("long press");
  }

  function releaseButton(button) {
    button.classList.add("controlButton");
    // button.classList.remove("buttonLocked");
    
  }

  function shortPress(button) {
    let opposite = getOpposite(button);
    console.log("short press");
    unlockEachDriveButtonIfThe_ALLinterface_IsUsed(button);
    opposite.classList.remove("buttonLocked");
    if (button.classList.contains("buttonLocked")) {
      button.classList.remove("buttonLocked");
    } else {
      button.classList.add("buttonLocked");
    }
    
  }

  function getOpposite(button) {
    let action = button.id.split("/")[0];
    let port = button.id.split("/")[1];
    let opposite = document.getElementById("driveDown/"+port);
    if (action == "driveDown") {
      opposite = document.getElementById("driveUp/"+port);
    }
    return opposite;
  }

  function unlockEachDriveButtonIfThe_ALLinterface_IsUsed(button) {
    let port = button.id.split("/")[1];
    if (port == "00") {
      let buttons = document.querySelectorAll(".buttonLocked");
      for (let i = 0; i < buttons.length; i++) {
        if (buttons[i] != button) {
          buttons[i].classList.remove("buttonLocked");
        }
      }
    } else {
        try {
          allUp.classList.remove("buttonLocked");
          allDown.classList.remove("buttonLocked");
        }
        catch {}
    }
  }


</script>

</div>


{% endblock %}